# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

TestKit is a Swift testing utilities library for the Swift Testing framework (with XCTest backward compatibility). It provides async test doubles, memory leak detection, UI presentation testing, and fluent expectation APIs.

- **Swift 6.2** / SPM package
- **Platforms**: iOS 17+, macOS 14+, macCatalyst 17+
- **Dependencies**: swift-custom-dump, swift-concurrency-extras (production); Mockable (tests only)

## Build & Test Commands

```bash
swift build -v          # Build the package
swift test -v           # Run all tests
swift test --filter TestKitTests.SomeTestSuite  # Run a specific test suite
```

CI runs on macOS 15 with latest stable Xcode via GitHub Actions (`swift.yml`).

## Architecture

### Source Layout (`Sources/TestKit/`)

**Test Doubles** — Core async spying infrastructure:
- `AsyncSpy` — Controls blocking async operations using `CheckedContinuation`. Call `async {}` or `synchronous {}` to wrap the operation, then `complete(with:)` to resolve it. Supports tagged calls for multiple concurrent operations.
- `FireAndForgetSpy` — For fire-and-forget async operations using `AsyncThrowingStream`. Results are polled via `result(at:timeout:)`.
- `CascadePolicy` — Configures cascading completion of sequential async calls (`asyncWithCascade`, `synchronousWithCascade`).

**Testing** (`Testing/`) — Extensions on `Test` for fluent test APIs:
- `Test.expect {}` — Fluent expectation tracker: `.toCompleteWith {}`, `.when {}`, `.execute()`
- `Test.trackForMemoryLeaks()` — Weak-reference based leak detection via `TeardownTrackingTrait`
- `Test.async()` — Low-level async control with `withMainSerialExecutor`
- `Test+TrackChange` — Property mutation tracking with `ChangeTracker`
- `Test+Persistance` — CoreData in-memory test container management via traits
- `ObservationSpy` — Actor for spying on Observation framework changes

**Common** — Shared building blocks:
- `ExpectationTracker` — Fluent builder for async result assertions
- `ChangeTracker` — Fluent builder for property change assertions

**UI** (UIKit, conditional compilation):
- `PresentationSpy` — Method swizzling on `UIViewController` to intercept present/dismiss
- `InstantAnimationStub` — Disables animations for deterministic tests

**Helpers**:
- `UUID.incrementing()` — Actor-based sequential UUID generator for deterministic tests
- Localization validation helpers

### Key Patterns

- **Dual framework support**: Methods have overloads for both Swift Testing (`SourceLocation`) and XCTest (`StaticString file, UInt line`) via `#if canImport(Testing)`.
- **Test traits**: Custom `TestTrait`/`SuiteTrait` implementations (e.g., `.teardownTracking()`, `.persistenceTestContainer()`, `.sequentialUUIDGeneration()`) handle setup/teardown via `TestScoping`.
- **`@MainActor` pervasive**: Test doubles and test suites use `@MainActor` for thread safety.
- **Fluent builder pattern**: `ExpectationTracker` and `ChangeTracker` use method chaining ending with `.execute()`.

## Code Style
- **File headers**: Auto-generated by SwiftFormat — `{file} / Copyright (c) {year} Moroverse / Created by {author} on {date}.`
- Test suites use `@Suite("Description")` with `@MainActor` and `@Test("description")` function annotations
